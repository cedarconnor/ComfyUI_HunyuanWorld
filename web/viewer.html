<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HunyuanWorld 3D Viewer - Enhanced</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #viewer {
            width: 100%;
            height: 100%;
        }
        
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 320px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 11px;
            max-width: 420px;
            max-height: 220px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .control-group {
            margin-bottom: 10px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
        }
        
        .control-group input, .control-group select {
            width: 100%;
            padding: 3px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 3px;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #layerControls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 280px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        .layer-checkbox {
            margin-right: 8px;
        }
        
        .layer-name {
            flex: 1;
            font-size: 11px;
        }
        
        .layer-opacity {
            width: 60px;
            margin-left: 8px;
        }
        
        #viewportInfo {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 10px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="viewer"></div>
        
        <div id="controls">
            <h3>HunyuanWorld Viewer</h3>
            
            <div class="control-group">
                <label>View Mode:</label>
                <select id="viewMode">
                    <option value="panorama">Panorama 360°</option>
                    <option value="wireframe">Wireframe</option>
                    <option value="solid">Solid</option>
                    <option value="textured">Textured</option>
                    <option value="layered">Layered View</option>
                    <option value="depth">Depth Map</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Rendering:</label>
                <select id="renderMode">
                    <option value="standard">Standard</option>
                    <option value="physical">Physical</option>
                    <option value="toon">Toon</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Field of View:</label>
                <input type="range" id="fov" min="30" max="120" value="75">
                <span id="fovValue">75°</span>
            </div>
            
            <div class="control-group">
                <button id="resetView">Reset View</button>
                <button id="fullscreen">Fullscreen</button>
            </div>
            
            <div class="control-group">
                <button id="exportView">Export View</button>
                <button id="exportMesh" disabled>Export Mesh</button>
            </div>
            
            <div class="control-group">
                <label>Quality:</label>
                <select id="renderQuality">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="ultra">Ultra</option>
                </select>
            </div>
        </div>
        
        <div id="layerControls">
            <h4>Layer Controls</h4>
            <div id="layerList">
                <!-- Dynamic layer controls will be added here -->
            </div>
        </div>
        
        <div id="viewportInfo">
            FPS: <span id="fps">60</span> | Triangles: <span id="triangles">0</span>
        </div>
        
        <div id="info">
            <div id="meshInfo">
                <strong>Scene Information:</strong><br>
                Type: <span id="sceneType">-</span><br>
                Vertices: <span id="vertexCount">-</span><br>
                Faces: <span id="faceCount">-</span><br>
                Textures: <span id="textureCount">-</span><br>
                Layers: <span id="layerCount">-</span><br>
                Memory: <span id="memoryUsage">-</span>
            </div>
            <br>
            <div id="instructions">
                <strong>Controls:</strong><br>
                • Left Mouse: Rotate view<br>
                • Wheel: Zoom in/out<br>
                • Right Mouse: Pan<br>
                • Middle Mouse: Focus object<br>
                • Double-click: Reset view<br>
                • 'F': Toggle fullscreen<br>
                • 'R': Reset camera<br>
                • '1-6': Switch view modes<br>
            </div>
        </div>
        
        <div id="loading" style="display: none;">
            <div class="spinner"></div>
            Loading 3D scene...
        </div>
    </div>

    <script>
        // HunyuanWorld 3D Viewer Implementation
        class HunyuanViewer {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.controls = null;
                this.mesh = null;
                this.panoramaTexture = null;
                
                this.setupEventListeners();
                this.initViewer();
            }
            
            setupEventListeners() {
                document.getElementById('viewMode').addEventListener('change', (e) => {
                    this.setViewMode(e.target.value);
                });
                
                document.getElementById('fov').addEventListener('input', (e) => {
                    this.setFieldOfView(parseInt(e.target.value));
                    document.getElementById('fovValue').textContent = e.target.value + '°';
                });
                
                document.getElementById('resetView').addEventListener('click', () => {
                    this.resetView();
                });
                
                document.getElementById('fullscreen').addEventListener('click', () => {
                    this.toggleFullscreen();
                });
                
                document.getElementById('exportView').addEventListener('click', () => {
                    this.exportView();
                });
                
                document.getElementById('exportMesh').addEventListener('click', () => {
                    this.exportMesh();
                });
                
                window.addEventListener('resize', () => {
                    this.onWindowResize();
                });
            }
            
            initViewer() {
                // This is a placeholder implementation
                // In a real implementation, you would use Three.js or similar
                console.log('HunyuanWorld 3D Viewer initialized');
                
                // Simulate loading
                this.showLoading(true);
                setTimeout(() => {
                    this.showLoading(false);
                    this.setupDefaultScene();
                }, 2000);
            }
            
            setupDefaultScene() {
                console.log('Setting up default scene');
                
                // Update mesh info with placeholder data
                document.getElementById('vertexCount').textContent = '1,000';
                document.getElementById('faceCount').textContent = '1,800';
                document.getElementById('textureCount').textContent = '2';
                
                // Enable export button
                document.getElementById('exportMesh').disabled = false;
            }
            
            loadPanorama(imageUrl) {
                console.log('Loading panorama:', imageUrl);
                this.showLoading(true);
                
                // Simulate panorama loading
                setTimeout(() => {
                    this.showLoading(false);
                    this.setupPanoramaView();
                }, 1500);
            }
            
            loadMesh(meshData) {
                console.log('Loading mesh data:', meshData);
                this.showLoading(true);
                
                // Simulate mesh loading
                setTimeout(() => {
                    this.showLoading(false);
                    this.setupMeshView(meshData);
                }, 2000);
            }
            
            setupPanoramaView() {
                console.log('Setting up panorama view');
                document.getElementById('viewMode').value = 'panorama';
            }
            
            setupMeshView(meshData) {
                console.log('Setting up mesh view');
                
                if (meshData) {
                    document.getElementById('vertexCount').textContent = 
                        meshData.vertices ? meshData.vertices.toLocaleString() : '-';
                    document.getElementById('faceCount').textContent = 
                        meshData.faces ? meshData.faces.toLocaleString() : '-';
                    document.getElementById('textureCount').textContent = 
                        meshData.textures ? meshData.textures.toString() : '-';
                }
                
                document.getElementById('exportMesh').disabled = false;
                document.getElementById('viewMode').value = 'textured';
            }
            
            setViewMode(mode) {
                console.log('Setting view mode:', mode);
                
                switch(mode) {
                    case 'panorama':
                        this.setupPanoramaMode();
                        break;
                    case 'wireframe':
                        this.setupWireframeMode();
                        break;
                    case 'solid':
                        this.setupSolidMode();
                        break;
                    case 'textured':
                        this.setupTexturedMode();
                        break;
                }
            }
            
            setupPanoramaMode() {
                console.log('Panorama mode activated');
                // In real implementation: show panorama as environment sphere
            }
            
            setupWireframeMode() {
                console.log('Wireframe mode activated');
                // In real implementation: render mesh as wireframe
            }
            
            setupSolidMode() {
                console.log('Solid mode activated');
                // In real implementation: render solid mesh without textures
            }
            
            setupTexturedMode() {
                console.log('Textured mode activated');
                // In real implementation: render mesh with full textures
            }
            
            setFieldOfView(fov) {
                console.log('Setting FOV:', fov);
                // In real implementation: update camera FOV
            }
            
            resetView() {
                console.log('Resetting view');
                // In real implementation: reset camera position and rotation
            }
            
            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }
            
            exportView() {
                console.log('Exporting current view');
                // In real implementation: capture current view as image
                
                // Simulate export
                const link = document.createElement('a');
                link.download = 'hunyuan_view.png';
                link.href = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
                link.click();
            }
            
            exportMesh() {
                console.log('Exporting mesh');
                // In real implementation: export mesh data
                
                // Simulate export
                alert('Mesh export functionality would be implemented here');
            }
            
            showLoading(show) {
                document.getElementById('loading').style.display = show ? 'block' : 'none';
            }
            
            onWindowResize() {
                console.log('Window resized');
                // In real implementation: update renderer and camera aspect ratio
            }
        }
        
        // Communication with ComfyUI parent window
        class ComfyUIBridge {
            constructor(viewer) {
                this.viewer = viewer;
                this.setupMessageHandling();
            }
            
            setupMessageHandling() {
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'hunyuan_data') {
                        this.handleHunyuanData(event.data);
                    }
                });
                
                // Send ready message to parent
                this.sendToParent({
                    type: 'viewer_ready',
                    timestamp: Date.now()
                });
            }
            
            handleHunyuanData(data) {
                console.log('Received data from ComfyUI:', data);
                
                switch(data.dataType) {
                    case 'panorama':
                        this.viewer.loadPanorama(data.imageUrl);
                        break;
                    case 'scene3d':
                        this.viewer.loadMesh({
                            vertices: data.vertices,
                            faces: data.faces,
                            textures: data.textures
                        });
                        break;
                    case 'worldmesh':
                        this.viewer.loadMesh({
                            vertices: data.vertices,
                            faces: data.faces,
                            textures: data.textures
                        });
                        break;
                }
            }
            
            sendToParent(message) {
                if (window.parent !== window) {
                    window.parent.postMessage(message, '*');
                }
            }
        }
        
        // Initialize viewer when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const viewer = new HunyuanViewer();
            const bridge = new ComfyUIBridge(viewer);
            
            // Make viewer globally accessible for debugging
            window.hunyuanViewer = viewer;
            window.comfyUIBridge = bridge;
        });
    </script>
</body>
</html>